require("dotenv").config();
const TelegramBot = require("node-telegram-bot-api");

const BOT_TOKEN = process.env.BOT_TOKEN; // –ò—Å–ø–æ–ª—å–∑—É–µ–º BOT_TOKEN
const GROUP_CHAT_ID_TWO = process.env.GROUP_CHAT_ID_TWO; // –£–∫–∞–∂–∏—Ç–µ ID –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã

const bot = new TelegramBot(BOT_TOKEN, { polling: true }); // –ò—Å–ø–æ–ª—å–∑—É–µ–º BOT_TOKEN –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

const userState = {};

const mainMenu = {
  reply_markup: {
    keyboard: [[{ text: "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—á–∞–ª–æ ‚Ü©Ô∏è" }]],
    resize_keyboard: true,
    one_time_keyboard: true,
  },
};

const vacancyMenu = {
  reply_markup: {
    keyboard: [
      [
        { text: "–ö—É—Ä—å–µ—Ä-–¥–æ—Å—Ç–∞–≤—â–∏–∫" },
        { text: "–°–±–æ—Ä—â–∏–∫ –∑–∞–∫–∞–∑–æ–≤" },
      ],
    ],
    resize_keyboard: true,
    one_time_keyboard: true,
  },
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function getUserMention(msg) {
  return msg.from.username ? `@${msg.from.username}` : `@id${msg.from.id}`;
}

bot.onText(/(start|–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—á–∞–ª–æ ‚Ü©Ô∏è)/, (msg) => {
  const chatId = msg.chat.id;
  userState[chatId] = { step: "/start", data: {} };

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤—ã–±–æ—Ä–æ–º –≤–∞–∫–∞–Ω—Å–∏–π
  bot.sendMessage(
    chatId,
    "üö¥üèº‚Äç‚ôÇÔ∏è –ö–æ–º–ø–∞–Ω–∏—è –°–∞–º–æ–∫–∞—Ç –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤–∞—Å –Ω–∞ —Ä–∞–±–æ—Ç—É!\n\n" +
      "–£ –Ω–∞—Å –µ—Å—Ç—å –¥–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏:\n" +
      "1Ô∏è‚É£ –ö—É—Ä—å–µ—Ä-–¥–æ—Å—Ç–∞–≤—â–∏–∫ ‚Äì –¥–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ –∏–ª–∏ –ø–µ—à–∫–æ–º.\n" +
      "2Ô∏è‚É£ –°–±–æ—Ä—â–∏–∫ –∑–∞–∫–∞–∑–æ–≤ ‚Äì –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ –≤ —Ü–µ–Ω—Ç—Ä–µ –≤—ã–¥–∞—á–∏.\n\n" +
      "–ê–∫—Ç—É–∞–ª–µ–Ω –ª–∏ –¥–ª—è –≤–∞—Å –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã? –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é –ø–æ–∑–∏—Ü–∏—é! üòä",
    vacancyMenu
  );

  // –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å–ª–æ–≤–∏—è—Ö —Ä–∞–±–æ—Ç—ã
  bot.sendMessage(
    chatId,
    "–°–∞–º–æ–∫–∞—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç –∑–æ–Ω—É –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –≤ –≥–æ—Ä–æ–¥–∞—Ö, –ø–æ—ç—Ç–æ–º—É –º—ã –≤—Å–µ–≥–¥–∞ –∏—â–µ–º –∫—É—Ä—å–µ—Ä–æ–≤ –∏ —Å–±–æ—Ä—â–∏–∫–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑–æ–≤.\n" +
      "\n–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å?\n" +
      "–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –≤ –±–æ—Ç–µ, –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫ –æ—Ç —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞, –í—ã–±—Ä–∞—Ç—å –¥–∞—Ä–∫—Å—Ç–æ—Ä, –ò–∑—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞\n" +
      "üí∏ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Ö–æ–¥ –∫–∞–∂–¥—ã–π —á–∞—Å, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤\n" +
      "–ê –µ—â—ë ‚Äî –¥–æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö, —á–∞–µ–≤—ã–µ, –±–æ–Ω—É—Å—ã –∑–∞ –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π –∏ –Ω–∞–¥–±–∞–≤–∫–∏ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫—É –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏\n" +
      "üèòÔ∏è –¶–µ–Ω—Ç—Ä —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –≤ —à–∞–≥–æ–≤–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Ç –¥–æ–º–∞.\n" +
      "üß≠ –†–∞–¥–∏—É—Å –¥–æ—Å—Ç–∞–≤–æ–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 0,1-3 –∫–º –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤.\n" +
      "üö¥ –ë–µ—Å–ø–ª–∞—Ç–Ω—É—é —É–Ω–∏—Ñ–æ—Ä–º—É, —à–ª–µ–º –∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥, —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥\n" +
      "üìÖ –ê–±—Å–æ–ª—é—Ç–Ω—É—é –≥–∏–±–∫–æ—Å—Ç—å –≤ –≤—ã–±–æ—Ä–µ –ø–µ—Ä–∏–æ–¥–æ–≤ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ (–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∑–∞–∫–∞–∑—ã –º–æ–∂–Ω–æ –æ—Ç 2-—Ö —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å).\n" +
      "üòå –ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –æ—Ç–¥—ã—Ö–∞ –∏ –æ–∂–∏–¥–∞–Ω–∏—è –≤ —Ü–µ–Ω—Ç—Ä–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤.\n" +
      "üßæ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —à—Ç—Ä–∞—Ñ–æ–≤.\n" +
      "‚úÖ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ —Å–∞–º–æ–∑–∞–Ω—è—Ç–æ—Å—Ç–∏. –û–ø–ª–∞—Ç—É –Ω–∞–ª–æ–≥–∞ –°–∞–º–æ–∫–∞—Ç –±–µ—Ä—ë—Ç –Ω–∞ —Å–µ–±—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–±–µ —Ä–µ–∞–ª—å–Ω—É—é —Å—É–º–º—É —Ç–≤–æ–µ–≥–æ –¥–æ—Ö–æ–¥–∞.",
    mainMenu
  );
});

bot.on("message", (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;
  const userMention = getUserMention(msg);

  console.log("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", text); // –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

  if (!userState[chatId]) {
    userState[chatId] = { step: "/start", data: {} };
  }

  const state = userState[chatId];

  switch (state.step) {
    case "/start":
      if (text.trim() === "–ö—É—Ä—å–µ—Ä-–¥–æ—Å—Ç–∞–≤—â–∏–∫") {
        console.log("–í—ã–±—Ä–∞–Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—è –ö—É—Ä—å–µ—Ä-–¥–æ—Å—Ç–∞–≤—â–∏–∫"); // –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        bot.sendMessage(chatId, "–¢–µ–∫—Å—Ç –æ –≤–∞–∫–∞–Ω—Å–∏–∏ –∫—É—Ä—å–µ—Ä–∞", mainMenu);
        state.step = "askName";
      } else if (text.trim() === "–°–±–æ—Ä—â–∏–∫ –∑–∞–∫–∞–∑–æ–≤") {
        console.log("–í—ã–±—Ä–∞–Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—è –°–±–æ—Ä—â–∏–∫ –∑–∞–∫–∞–∑–æ–≤"); // –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        bot.sendMessage(chatId, "–¢–µ–∫—Å—Ç –æ –≤–∞–∫–∞–Ω—Å–∏–∏ —Å–±–æ—Ä—â–∏–∫–∞", mainMenu);
        state.step = "askCity";
      }
      break;

    case "askCity":
      state.data.city = text;
      bot.sendMessage(chatId, "–û—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", { reply_markup: { force_reply: true } });
      state.step = "askPhone";
      break;

    case "askPhone":
      state.data.phone = text;
      const userInfo = `–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞:\n–ò–º—è: ${state.data.name || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"}\n–ì–æ—Ä–æ–¥: ${state.data.city || "–ù–µ —É–∫–∞–∑–∞–Ω"}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${state.data.phone}\nID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userMention}`;
      bot.sendMessage(GROUP_CHAT_ID_TWO, userInfo);
      bot.sendMessage(chatId, "–°–ø–∞—Å–∏–±–æ! HR-–º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.", mainMenu);
      state.step = "/start";
      break;

    default:
      bot.sendMessage(chatId, "–û—à–∏–±–∫–∞. –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å–Ω–∞—á–∞–ª–∞.", mainMenu);
      state.step = "/start";
      break;
  }
});
